#!/bin/sh
# SH FILE: el-byte-compile
#
# Purpose   : Byte compile an Emacs Lisp file in isolation.
# Created   : Tuesday, December  2 2025.
# Author    : Pierre Rouleau <prouleau001@gmail.com>
# Time-stamp: <2025-12-02 15:23:15 EST, updated by Pierre Rouleau>
# ----------------------------------------------------------------------------
# Module Description
# ------------------
#
# Byte-Compile a single Emacs Lisp file.  Generate the .elc file.


# ----------------------------------------------------------------------------
# Dependencies
# ------------
#
# POSIX compliant shell, Emacs.

# ----------------------------------------------------------------------------
# Code
# ----
#
#

pgm_name="$(basename "$0")"

print_usage()
{
    printf -- "
%s -- byte-compile Emacs Lisp file in isolation

 Usage: %s -h|--help

  • Print this help information.

 Usage: %s [-W|--warn-as-error] FILE

  • Byte-compile Emacs Lisp FILE.
  • If --warn-as-error is specified treat warnings as errors and stop
    on the first warning detected.
" "$pgm_name" "$pgm_name" "$pgm_name"
}

# --
# Check validity of arguments

if [ "$1" = "-h" ] || [ "$1" = "--help" ]; then
    print_usage
    if [ "$#" = "1" ]; then
        # help requested explicitly with right amount of args: no error.
        exit 0
    else
        exit  1
    fi
fi

# Check Options
options=1
warning_as_error=false
while [ "$options" -ge 1 ]; do
    case "$1" in
        --warn-as-error|-W)
            warning_as_error=true
            shift
            ;;

        --)
            shift
            continue
            ;;

        -*)
            printf -- "\
*** ERROR: %s: invalid options: %s\n" "${pgm_name}" "$1" 1>&2
            exit 1
            ;;

        *)
            break
            ;;
    esac
    options=$(( options - 1 ))
done

if [ -z "$1" ]; then
    printf -- "** ERROR: el-byte-compile: missing FILE\n Use -h to see usage\n"
    exit 1
fi

if [ "${warning_as_error}" = "true" ]; then
    set -x
    emacs -Q --batch -L .  --eval '(setq byte-compile-error-on-warn t)' -f batch-byte-compile "$1"
else
    set -x
    emacs -Q --batch -L .  -f batch-byte-compile "$1"
fi

# ----------------------------------------------------------------------------
