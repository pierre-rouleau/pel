#!/bin/sh
# SH FILE: el-byte-compile
#
# Purpose   : Byte compile an Emacs Lisp file in isolation.
# Created   : Tuesday, December  2 2025.
# Author    : Pierre Rouleau <prouleau001@gmail.com>
# Time-stamp: <2026-01-23 09:26:01 EST, updated by Pierre Rouleau>
# ----------------------------------------------------------------------------
# Module Description
# ------------------
#
# Byte-Compile a single Emacs Lisp file.  Generate the .elc file.

# ----------------------------------------------------------------------------
# Dependencies
# ------------
#
# POSIX compliant shell, Emacs.

# ----------------------------------------------------------------------------
# Code
# ----
#
pgm_name="$(basename "$0")"

print_usage()
{
    printf -- "
%s -- byte-compile Emacs Lisp file in isolation

 Usage: %s -h|--help

  • Print this help information.

 Usage: %s [-W|--warn-as-error] FILE

  • Byte-compile Emacs Lisp FILE.
  • If --warn-as-error is specified treat warnings as errors and stop
    on the first warning detected in byte compilation.
    Also perform native compilation if Emacs supports it and stop on
    any native compilation warning.

 Limitation: the Emacs Lisp file compiled and all Emacs Lisp dependencies
             of the compiled file MUST be located in the current directory,
             because Emacs load path normally used is ignored and replaced
             by a single directory: the current one.
" "$pgm_name" "$pgm_name" "$pgm_name"
}

# --
# Check validity of arguments

if [ "$1" = "-h" ] || [ "$1" = "--help" ]; then
    print_usage
    if [ "$#" = "1" ]; then
        # help requested explicitly with right amount of args: no error.
        exit 0
    else
        exit  1
    fi
fi

# Check Options
options=1
warning_as_error=false
while [ "$options" -ge 1 ]; do
    case "$1" in
        --warn-as-error|-W)
            warning_as_error=true
            shift
            ;;

        --)
            shift
            continue
            ;;

        -*)
            printf -- "\
*** ERROR: %s: invalid options: %s\n" "${pgm_name}" "$1" 1>&2
            exit 1
            ;;

        *)
            break
            ;;
    esac
    options=$(( options - 1 ))
done

if [ -z "$1" ]; then
    printf -- "** ERROR: el-byte-compile: missing FILE\n Use -h to see usage\n"
    exit 1
fi

emacs_can_native_compile=$(emacs --batch --eval '(when
                                                  (and (fboundp (quote native-comp-available-p))
                                                       (native-comp-available-p))
                                                    (princ "yes"))')

if [ "${warning_as_error}" = "true" ]; then
    set -x
    emacs -Q --batch -L .  --eval '(setq byte-compile-error-on-warn t)' -f batch-byte-compile "$1"
    { set +x; } 2>/dev/null
    if [ "${emacs_can_native_compile}" = "yes" ]; then
        set -x
	      emacs -Q --batch -L .  --eval '(setq byte-compile-error-on-warn t)' -f batch-native-compile "$1"
    fi
else
    set -x
    emacs -Q --batch -L .  -f batch-byte-compile "$1"
fi

# ----------------------------------------------------------------------------
