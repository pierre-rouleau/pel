#!/bin/sh
# SH FILE: ert-test
#
# Purpose   : Run an Ert test
# Created   : Wednesday, February 25 2026.
# Author    : Pierre Rouleau <prouleau001@gmail.com>
# Time-stamp: <2026-02-27 11:54:24 EST, updated by Pierre Rouleau>
# ----------------------------------------------------------------------------
# Module Description
# ------------------
#
# Run an Ert test file specified on the command line argument.
# Activate the maximum level of back trace capability I have found.

# ----------------------------------------------------------------------------
# Code
# ----
#
#

# Identify program name.
pgm_name="$(basename "$0")"
EMACS_BIN="${EMACS:-emacs}"

print_usage()
{
    printf -- "
%s -- Run the Emacs Ert test.

 Usage: %s -h|--help

  • Print this help information.

 Usage: %s TEST-FILE [EMACS-BIN]

  • Print the name of TEST-FILE and run the Emacs Ert test that is
    the test/TEST_FILE.
  • If the EMACS-BIN argument is specified it identifies the name of
    the emacs executable.
  • When the test passes, create a file with the same name and a
    '.test-passed' suffix and exit with an exit code of 0.
    These tag files are used by the Make file to identify tests that
    do not need to be re-executed.
  • Exit with 1 on error.

"  "$pgm_name" "$pgm_name" "$pgm_name"
}

# --
# Check validity of arguments

if [ -z "$1" ]; then
    print_usage
    exit 1
fi

if [ "$1" = "-h" ] || [ "$1" = "--help" ]; then
    print_usage
    if [ "$#" = "1" ]; then
        # help requested explicitly with right amount of args: no error.
        exit 0
    else
        exit  1
    fi
fi

if [ -n "$2" ]; then
    EMACS_BIN="$2"
fi

# --
# Proceed.

printf -- "---------------------------------------------------------------\n"
printf -- "-- Testing %s:\n" "$1"
if [ -f "$1" ]; then
    # -L . : add current directory to load path to allow using the code.
    # Attempt to prevent truncation of back-traces.
    set -x
    if EMACS_TEST_VERBOSE=1 "$EMACS_BIN" -batch -L . -l ert -l "$1" \
                            --eval '(setq ert-batch-print-length nil ert-batch-print-level nil)' \
                            -f ert-run-tests-batch-and-exit; then
        touch "$1.test-passed"
    fi

else
    printf -- "*** ERROR: file does not exists: test/%s\n" "$1"
    exit 1
fi

# ----------------------------------------------------------------------------
