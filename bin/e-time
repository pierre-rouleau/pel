#!/bin/sh
# SH FILE: e-time.sh
#
# Purpose   : Time Emacs startup.
# Created   : Monday, February 23 2026.
# Author    : Pierre Rouleau <prouleau001@gmail.com>
# Time-stamp: <2026-02-24 17:55:10 EST, updated by Pierre Rouleau>
# ----------------------------------------------------------------------------
# Module Description
# ------------------
#
#  Measure Emacs startup time when started in various ways, without and with PEL
#  initialization.  Compute and print the number of packages loaded by PEL
#  since this has a significant impact on Emacs starup time.

# ----------------------------------------------------------------------------
# Dependencies
# ------------
#
# - Emacs must be installed and PEL commands are used.

# ----------------------------------------------------------------------------
# Code
# ----
#
#
# shellcheck disable=SC2129  # one redirection by line, no grouping: easier to see.

# Identify program name.
pgm_name="$(basename "$0")"

# Identify path of the program
TARGET="$0"
# Handle symlinks to the script
while [ -L "$TARGET" ]; do
  # Get the link's target path
  # Note: ls -ld is the standard POSIX way to see where a link points
  # shellcheck disable=SC2012
  LINK_TARGET=$(ls -ld "$TARGET" | sed 's/.*-> //')

  case "$LINK_TARGET" in
    /*) # Absolute link target
        TARGET="$LINK_TARGET" ;;
    *)  # Relative link target: resolve relative to the current link's directory
        TARGET="$(dirname -- "$TARGET")/$LINK_TARGET" ;;
  esac
done
SCRIPT_DIR=$(cd -P -- "$(dirname -- "$TARGET")" && pwd)

# Now compute PEL_DIR, the directory where Makefile is located.
PEL_DIR="$(realpath "${SCRIPT_DIR}/..")"



print_usage()
{
    printf -- "
%s -- Check Emacs startup time under various conditions.

 Usage: %s -h|--help

  • Print this help information.

 Usage: %s [-g|--gui] [REPORT_FILE]

  • Measure Emacs startup time under various conditions and
    generate a report which also identifies the number of packages
    loaded by Emacs under PEL.
  • By default only perform test on terminal-based Emacs
    If the -g (or --gui) option is specified, also perform test on
    GUI version of Emacs.
  • If a REPORT_FILE is specified store the report in that file.
    Otherwise generate a report in a temporary file.
    In both cases, print the generated report on stdout.

  The operation takes some time when detecting the number of packages used by
  PEL, so it prints a 'please wait' message while generating the report.

  Note that the script uses the file ~/tmp/emacs-time.txt to store
  information that is later added into the report.  The script
  stop with  an error if the directory does not exist or the file is present.

" "$pgm_name" "$pgm_name" "$pgm_name"
}

# --
# Check validity of arguments

if [ "$1" = "-h" ] || [ "$1" = "--help" ]; then
    print_usage
    if [ "$#" = "1" ]; then
        # help requested explicitly with right amount of args: no error.
        exit 0
    else
        exit  1
    fi
fi

# --
# Check -g options
test_gui=no
if [ "$1" = "-g" ] || [ "$1" = "--gui" ]; then
    test_gui=yes
    shift
fi

# --
# Prevent switches to be identified as REPORT_FILE

# Allow explicit end-of-options.
if [ "$1" = "--" ]; then
    shift
fi
# Reject extra args / unknown options.
if [ "$#" -gt 1 ]; then
    printf -- "*** ERROR: too many arguments.\n"
    printf -- "           Use -h to print help.\n"
    exit 1
fi
if [ "$#" -eq 1 ] && [ "${1#-}" != "$1" ]; then
    printf -- "*** ERROR: unknown option: %s\n" "$1"
    printf -- "           Use -h to print help.\n"
    exit 1
fi

# --
# Ensure the presence of ~/tmp directory
# And the absence of ~/tmp/emacs-time.txt
if [ ! -d "$HOME/tmp" ]; then
    printf -- "*** ERROR: required ~/tmp directory is missing. Please create it!\n"
    exit 2
fi
if [ -f "$HOME/tmp/emacs-time.txt" ]; then
    printf -- "*** ERROR: Please rename or erase ~/tmp/emacs-time.txt.\n"
    exit 2
fi

# --
# If no report file specified, then use a temporary file.

if [ -z "$1" ]; then
    REPORT_FILE=$(mktemp "${TMPDIR:-/tmp}/e-time.XXXXXX") || exit 1
    # Schedule erase of temp file on script termination.
    # The 'trap' command registers a cleanup function to run when the script receives
    # specific signals (0=EXIT, 2=SIGINT/Ctrl+C, 15=SIGTERM).
    trap 'rm -f "$REPORT_FILE"' EXIT INT TERM
else
    REPORT_FILE="$1"
fi

# --
# Proceed

printf -- "Please wait while generating the report...\n"

printf -- "--------- e-time report %s ------\n" "$(date +"%Y-%m-%d %T")" > "$REPORT_FILE"
printf -- "On: %s\n\n" "$(uname -a)"                               >> "$REPORT_FILE"
printf -- "TESTING: -Q\n"                                          >> "$REPORT_FILE"
printf -- "===========\n"                                          >> "$REPORT_FILE"
printf -- "\nTerminal startup: emacs -nw -Q -e kill-emacs :"       >> "$REPORT_FILE"
(time emacs -nw -Q -e kill-emacs)                                 2>> "$REPORT_FILE"
printf -- "\nTerminal startup: e -Q -e kill-emacs :"               >> "$REPORT_FILE"
(time  e -Q -e kill-emacs)                                        2>> "$REPORT_FILE"
printf -- "\n"                                                     >> "$REPORT_FILE"
if [ "$test_gui" = "yes" ]; then
    printf -- "\nGraphical startup: emacs -Q -e kill-emacs :"      >> "$REPORT_FILE"
    (time  emacs -Q -e kill-emacs)                                2>> "$REPORT_FILE"
    printf -- "\nGraphical startup: ge  -Q -e kill-emacs :"        >> "$REPORT_FILE"
    (time  ge  -Q -e kill-emacs)                                  2>> "$REPORT_FILE"
fi

printf -- "\n\n"                                                   >> "$REPORT_FILE"
printf -- "TESTING: -q\n"                                          >> "$REPORT_FILE"
printf -- "===========\n"                                          >> "$REPORT_FILE"
printf -- "\nTerminal startup: emacs -nw -q -e kill-emacs :"       >> "$REPORT_FILE"
(time  emacs -nw -q -e kill-emacs)                                2>> "$REPORT_FILE"
printf -- "\nTerminal startup: e -q -e kill-emacs :"               >> "$REPORT_FILE"
(time  e -q -e kill-emacs)                                        2>> "$REPORT_FILE"
if [ "$test_gui" = "yes" ]; then
    printf -- "\nGraphical startup: emacs -q -e kill-emacs :"      >> "$REPORT_FILE"
    (time  emacs -q -e kill-emacs)                                2>> "$REPORT_FILE"
    printf -- "\nGraphical startup: ge  -q -e kill-emacs :"        >> "$REPORT_FILE"
    (time  ge -q -e kill-emacs)                                   2>> "$REPORT_FILE"
fi

printf -- "\n\n"                                                   >> "$REPORT_FILE"
printf -- "TESTING: with PEL\n"                                    >> "$REPORT_FILE"
printf -- "==================\n"                                   >> "$REPORT_FILE"
printf -- "With "                                                  >> "$REPORT_FILE"
# remove the leading "- " printed by the make stats with sed.
make -C "${PEL_DIR}" stats 2>&1 | grep "# packages activated" | sed 's/^- //' >> "$REPORT_FILE"
printf -- "\nTerminal startup: emacs -nw -e kill-emacs :"          >> "$REPORT_FILE"
(time  emacs -nw -e kill-emacs)                                   2>> "$REPORT_FILE"
printf -- "\nTerminal startup: e -e kill-emacs :"                  >> "$REPORT_FILE"
(time  e -e kill-emacs)                                           2>> "$REPORT_FILE"
printf -- "\nTerminal startup, using emacs-init-time:\n"           >> "$REPORT_FILE"
(e --batch -l ~/.emacs.d/init.el  --eval '(progn (pel-init) (message "Emacs startup time (batch mode): %s" (emacs-init-time)))') 2>&1 | grep "Emacs startup time (batch mode):" >> "$REPORT_FILE"
(e --eval '(progn (write-region (format "Emacs startup time (user mode) : %s\n" (emacs-init-time)) nil "~/tmp/emacs-time.txt"  t) (kill-emacs))')
cat "$HOME/tmp/emacs-time.txt" >> "$REPORT_FILE"
rm -f "$HOME/tmp/emacs-time.txt"

if [ "$test_gui" = "yes" ]; then
    printf -- "\nGraphical startup: emacs -e kill-emacs :"         >> "$REPORT_FILE"
    (time  emacs -e kill-emacs)                                   2>> "$REPORT_FILE"
    printf -- "\nGraphical startup: ge  -e kill-emacs :"           >> "$REPORT_FILE"
    (time  ge -e kill-emacs)                                      2>> "$REPORT_FILE"
    printf -- "Note that the above times are invalid as ge is async\n" >> "$REPORT_FILE"
fi
printf -- "------------ COMPLETE ---------------\n"                >> "$REPORT_FILE"

cat "$REPORT_FILE"

# ----------------------------------------------------------------------------
